name: Build and test iOS App

on:
  workflow_dispatch:

jobs:
  build-ios-app:
    runs-on: macos-12
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 16.10.0

      - name: install
        run: npm install detox --save-dev && npm i -g detox-cli

      - name: run testt
        run: detox

      - name: Install apple simulator
        run: |
          brew tap wix/brew
          brew install applesimutils
      - name: Setup ruby
        uses: ruby/setup-ruby-pkgs@v1
        with:
          ruby-version: '2.7.5'
          bundler-cache: true

      - name: check
        run: applesimutils --list --byType "iPhone 13"

      - name: check booted 0
        run: /usr/bin/xcrun simctl boot D2C09DB6-1A6A-42FF-B27A-55689B856B4E

      - name: cheeek
        run: /usr/bin/xcrun simctl bootstatus D2C09DB6-1A6A-42FF-B27A-55689B856B4E

      - name: check booted
        run: xcrun simctl list

      - name: Cache pods
        uses: actions/cache@v3
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}

      - name: Setup Cocoapods
        run: npm run setup

      - name: Get bundle version
        id: version
        run: echo "IOS_VERSION=$(/usr/libexec/PlistBuddy -c "print :CFBundleVersion" ./ios/YourAwesomeProject/Info.plist)" >> $GITHUB_OUTPUT

      # - name: Cache Native Build
      #   id: cached-native-build
      #   uses: actions/cache@v3
      #   with:
      #     path: ios/build/Build/Products/Release-iphonesimulator
      #     key: ios-bundle-V${{ steps.version.outputs.IOS_VERSION }}

      - name: Generate iOS Simulator build
        if: steps.cached-native-build.outputs.cache-hit != 'true'
        run: detox build --configuration ios.sim.release

      # - name: Swap JS Bundle and assets
      #   run: |
      #     if [[ -f ios/build/Build/Products/Release-iphonesimulator/YourAwesomeProject.app/main.jsbundle ]]; then
      #       echo "$FILE exists!"
      #     else
      #       npx react-native bundle --entry-file index.js --bundle-output ios/build/Build/Products/Release-iphonesimulator/YourAwesomeProject.app/main.jsbundle --assets-dest ios/build/Build/Products/Release-iphonesimulator/YourAwesomeProject.app/assets
      #     fi
      # - name: check
      #   run: |
      #     xcrun simctl boot 53FBFB14-B98C-40BA-A020-EECFE78E29C8
      #     xcrun simctl list

      - name: run test
        run: detox test --configuration ios.sim.release --loglevel trace --record-logs all

      - uses: actions/upload-artifact@v3
        with:
          name: debug-artifact
          path: ${{ github.workspace }}/artifacts/**/*

      # - name: Cleanup JS Bundle
      #   working-directory: ios/build/Build/Products/Release-iphonesimulator/YourAwesomeProject.app
      #   if: steps.cached-native-build.outputs.cache-hit != 'true'
      #   run: rm -rf main.jsbundle assets
